Day 19: Cryptolocker Ransomware
===============================
> Pay the price, Thumper did it already!
> 
> This flag has been taken for ransom. Transfer 10'000 Szabo to 0x1337C8b69bcb49d677D758cF541116af1F2759Ca with your HACKvent username (case sensitive) in the transaction data to get your personal decryption key. To get points for this challenge, enter the key in the form below.
> 
> Disclaimer: No need to spend r34l m0n3y!
> 
> Enter your 32-byte decryption key here. Type it as 64 hexadecimal characters without 0x at the beginning.

Here we have a smart contract in ethereum and we are given the address of the smart contract. This was my first hand-on with ethereum and I learned a lot :)

A first step was to get the code of the smart contract. This can be found at <https://etherscan.io/address/0x1337C8b69bcb49d677D758cF541116af1F2759Ca#code> We get the code in the for of a hexadecimal blob:
```
0x6060604052600436106100405763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663ea8796348114610154575b662386f26fc100003410610152577fec29ee18c83562d4f2e0ce62e38829741c2901da844c015385a94d8c9f03d486600260003660116000604051602001526040517f485631372d00000000000000000000000000000000000000000000000000000081526005810184848082843782019150508260ff167f0100000000000000000000000000000000000000000000000000000000000000028152600101935050505060206040518083038160008661646e5a03f1151561010157600080fd5b5050604051805190506040519081526040602082018190526011818301527f596f7572206b657920697320686572652e00000000000000000000000000000060608301526080909101905180910390a15b005b341561015f57600080fd5b61015260005473ffffffffffffffffffffffffffffffffffffffff9081169030163180156108fc0290604051600060405180830381858888f1935050505015156101a857600080fd5b5600a165627a7a7230582020304ba8cb5786445e5c47f840741111591a38057d40ac139568b31f9eaee3c70029
```

The same site helps to get the opcodes but actually I found it easier using the code produced by porosity <https://github.com/comaeio/porosity/>. I disassembled it with:
```
$ ./porosity --code 6060604052600436106100405763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663ea8796348114610154575b662386f26fc100003410610152577fec29ee18c83562d4f2e0ce62e38829741c2901da844c015385a94d8c9f03d486600260003660116000604051602001526040517f485631372d00000000000000000000000000000000000000000000000000000081526005810184848082843782019150508260ff167f0100000000000000000000000000000000000000000000000000000000000000028152600101935050505060206040518083038160008661646e5a03f1151561010157600080fd5b5050604051805190506040519081526040602082018190526011818301527f596f7572206b657920697320686572652e00000000000000000000000000000060608301526080909101905180910390a15b005b341561015f57600080fd5b61015260005473ffffffffffffffffffffffffffffffffffffffff9081169030163180156108fc0290604051600060405180830381858888f1935050505015156101a857600080fd5b5600a165627a7a7230582020304ba8cb5786445e5c47f840741111591a38057d40ac139568b31f9eaee3c70029 --disasm
Porosity v0.1 (https://www.comae.io)
Matt Suiche, Comae Technologies <support@comae.io>
The Ethereum bytecode commandline decompiler.
Decompiles the given Ethereum input bytecode and outputs the Solidity code.

- Total byte code size: 0x1d6 (470)


loc_00000000:
0x00000000 60 60                      PUSH1 60
0x00000002 60 40                      PUSH1 40
0x00000004 52                         MSTORE
0x00000005 60 04                      PUSH1 04
0x00000007 36                         CALLDATASIZE
0x00000008 10                         LT
0x00000009 61 40  00                  PUSH2 40 00
0x0000000c 57                         JUMPI
[CUT BY trolli101]
```

A paper from the developer of porosity helped me to find a way to emulate the code <https://www.comae.io/reports/dc25-msuiche-Porosity-Decompiling-Ethereum-Smart-Contracts-wp.pdf>. On page 19, the EVM emulator from geth client is used (<https://geth.ethereum.org>).

I could then run the smart contract with:
```
$ ./evm --code <the code blob> --input 5468756d706572 --debug run
```

This allows to check the result with Thumper's transaction. However, the code does not return anything and when adding the `--debug` flag, we see that the execution is stopped because at offset `0x4e`we have a jump that is triggered by the value of the transaction being too low (the value of the transaction is compared with a constant and if the transaction's value is lower, jump to a termination function):
```
loc_00000040:
0x00000040 5b                         JUMPDEST
0x00000041 66 00  00  c1  6f  +      PUSH7 00 00 c1 6f f2 86 23
0x00000049 34                         CALLVALUE
0x0000004a 10                         LT
0x0000004b 61 52  01                  PUSH2 52 01
0x0000004e 57                         JUMPI
```

To bypass this one can simply replace the condition LT by GT such that our value of 0 is accepted. This means the opcode 10 is replaced with 11 at offset `0x4a`. Using this modified bytecode, the transaction from Thumper can be checked with:
```
./evm --code 6060604052600436106100405763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663ea8796348114610154575b662386f26fc100003411610152577fec29ee18c83562d4f2e0ce62e38829741c2901da844c015385a94d8c9f03d486600260003660116000604051602001526040517f485631372d00000000000000000000000000000000000000000000000000000081526005810184848082843782019150508260ff167f0100000000000000000000000000000000000000000000000000000000000000028152600101935050505060206040518083038160008661646e5a03f1151561010157600080fd5b5050604051805190506040519081526040602082018190526011818301527f596f7572206b657920697320686572652e00000000000000000000000000000060608301526080909101905180910390a15b005b341561015f57600080fd5b61015260005473ffffffffffffffffffffffffffffffffffffffff9081169030163180156108fc0290604051600060405180830381858888f1935050505015156101a857600080fd5b5600a165627a7a7230582020304ba8cb5786445e5c47f840741111591a38057d40ac139568b31f9eaee3c70029 --input 5468756d706572 --debug run
[CUT BY trolli101]
#### LOGS ####
LOG1: 0000000000000000000000007265636569766572 bn=0 txi=0
00000000  ec29ee18c83562d4f2e0ce62e38829741c2901da844c015385a94d8c9f03d486
00000000  98 80 cc cf e8 1a 07 5f  f0 d0 29 b4 35 1e f4 49  |......._..).5..I|
00000010  6a e4 52 19 9b 83 16 34  af 57 e5 95 14 66 34 9d  |j.R....4.W...f4.|
00000020  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 40  |...............@|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 11  |................|
00000060  59 6f 75 72 20 6b 65 79  20 69 73 20 68 65 72 65  |Your key is here|
00000070  2e 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
```

And this confirms that the output of the run (2 first lines) are the result of the transaction that is visible at <https://etherscan.io/tx/0x6d5d42529ea3945df02a8cc8e6b16bd549b4cfced4e24e8f258e353a772995fb#eventlog>. Then it is only a matter of running the same code with my username as input to get the hex key:
```
$ ./evm --code 6060604052600436106100405763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663ea8796348114610154575b662386f26fc100003411610152577fec29ee18c83562d4f2e0ce62e38829741c2901da844c015385a94d8c9f03d486600260003660116000604051602001526040517f485631372d00000000000000000000000000000000000000000000000000000081526005810184848082843782019150508260ff167f0100000000000000000000000000000000000000000000000000000000000000028152600101935050505060206040518083038160008661646e5a03f1151561010157600080fd5b5050604051805190506040519081526040602082018190526011818301527f596f7572206b657920697320686572652e00000000000000000000000000000060608301526080909101905180910390a15b005b341561015f57600080fd5b61015260005473ffffffffffffffffffffffffffffffffffffffff9081169030163180156108fc0290604051600060405180830381858888f1935050505015156101a857600080fd5b5600a165627a7a7230582020304ba8cb5786445e5c47f840741111591a38057d40ac139568b31f9eaee3c70029 --input 74726f6c6c69313031 --debug run
[CUT BY trolli101]
#### LOGS ####
LOG1: 0000000000000000000000007265636569766572 bn=0 txi=0
00000000  ec29ee18c83562d4f2e0ce62e38829741c2901da844c015385a94d8c9f03d486
00000000  de 92 2b 30 d3 c2 1b 67  c5 5c aa 09 83 d1 38 3d  |..+0...g.\....8=|
00000010  3c a6 c9 bd c5 f6 85 50  20 97 8d 87 12 99 cc 28  |<......P ......(|
00000020  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 40  |...............@|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 11  |................|
00000060  59 6f 75 72 20 6b 65 79  20 69 73 20 68 65 72 65  |Your key is here|
00000070  2e 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
```

So in the end my key was:
```
de922b30d3c21b67c55caa0983d1383d3ca6c9bdc5f6855020978d871299cc28
```


